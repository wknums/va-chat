# Public Sector AI Chatbot Project

## Project Overview
Create a robust, enterprise-grade AI chatbot solution for Regional Government public websites. The chatbot will provide citizens with intelligent search and conversational assistance for government services, information, and resources.

## Current Status: Phase 1A Complete ✅ + Azure AI Search Integration

### ✅ COMPLETED FEATURES
1. **FastAPI Backend** with dual-agent system (AI Search + Bing fallback)
2. **Azure AI Search Integration** with working citations and originalSourceURL mapping
3. **Floating Chat Widget** with responsive, resizable design
4. **Dual Modes**: Chat (conversational) and Search (results list)
5. **Citation System** with real URLs from Azure AI Search documents
6. **URL Mapping Utility** for document filename to URL resolution
7. **Thread Management** with conversation persistence
8. **Request Logging** for debugging and monitoring
9. **Cross-platform compatibility** (Windows/Linux)
10. **Production-ready Docker containerization**

### ✅ AZURE AI SEARCH INTEGRATION
- **Government documents indexed** in Azure AI Search with originalSourceURL field
- **Working citations** with real government document URLs
- **Dual-agent architecture**: Primary (AI Search) + Fallback (Bing) agents
- **URL mapping utility** successfully deployed for document resolution
- **Citation extraction** with title improvement from document filenames
- **Cache management** via "Clear conversation" feature for fresh search results

## Project Context
- **Customer**: Public Sector Government
- **Target Users**: Public citizens accessing government services and information
- **Current Status**: Phase 1A Complete + Azure AI Search Integration Working
- **Development Approach**: Iterative development with local testing using saved HTML pages
- **Test Data Location**: `./sample-site/` and `./site/` folders contain sample pages
- **Knowledge Base**: Government documents indexed in Azure AI Search with working citations
- **Production Ready**: Docker containerization and Terraform IaC available

## Technical Architecture

### Phase 1A - Core Chat Functionality (Public Access)

#### Backend Components
1. **Azure AI Foundry Agent Service** (EXISTING)
   - Pre-configured agent with Bing Custom Search grounding
   - Environment variables in `.env` for connection details
   - Use Azure AI Foundry Projects SDK for agent orchestration
   
2. **FastAPI Chat API** (NEW)
   - Host on Azure Container Apps
   - RESTful endpoints for chat and search interactions
   - WebSocket support for streaming responses
   - Health checks and monitoring endpoints
   
3. **M365 Agent SDK** (NEW)
   - Agent service integration for multi-channel support
   - Direct Line channel for web integration
   - Conversation state management

4. **Authentication & Security**
   - **Entra ID** (formerly Azure AD) for API security
   - **Managed Identity** for Azure resource access
   - **NO API KEYS** - Use Entra ID authentication throughout
   - Public access (no user authentication required in Phase 1)

#### Frontend Components
1. **Chatbot UI Widget**
   - Embeddable widget compatible with existing website HTML
   - Two operational modes:
     - **Chat Mode** (Default): Conversational interface with citations
     - **Search Mode**: Traditional search results list with clickable URLs
   - **Expandable/Resizable**: From compact widget to full-screen mode
   - Responsive design for mobile and desktop
   - Accessibility compliance (WCAG 2.1 AA)

2. **UI Features**
   - Smooth expand/collapse animations
   - Mode toggle (Chat ↔ Search)
   - Citation references for AI responses
   - Search result cards with URLs, titles, and snippets
   - Loading states and error handling
   - Message history persistence

### Phase 1B - Enhanced Knowledge Base

#### Additional Knowledge Sources
1. **Azure AI Search Integration** (RE-USE EXISTING)
   - Index FAQ content
   - Hybrid search (vector + keyword)
   - Integrate with existing Azure AI Search resource
   - Combine with Bing Custom Search results

2. **Multi-Source Grounding**
   - Bing Custom Search: Web content, government pages
   - Azure AI Search: Structured FAQ, internal documents
   - Source attribution in responses

### Phase 2 - Authenticated Services (FUTURE)

#### Authentication Requirements
- **Contact Us Forms**: User authentication required
- **Actionable Services**: Job applications, permit requests, etc.
- **User Profile**: Store preferences and history
- **Entra ID B2C** for citizen authentication

## Technical Requirements

### Azure Resources Needed

| Resource | Status | Purpose |
|----------|--------|---------|
| Azure AI Foundry Agent | ✅ EXISTING | Core AI agent with Bing grounding |
| Azure AI Search | ✅ EXISTING | FAQ indexing (Phase 1B) |
| Azure Storage Account | ✅ EXISTING (if required) | Document storage, logs (re-use if available) |
| M365 Agent SDK | ❌ NEW | Multi-channel agent service |
| Azure Container Registry | ❌ NEW | Docker image storage for ACA |
| Azure Container Apps | ❌ NEW | FastAPI hosting via Docker containers |
| Azure Entra ID | ✅ EXISTING | Authentication & authorization |
| Managed Identity | ❌ NEW | Secure resource access |

### Security & Compliance
- **Zero API Keys**: All authentication via Entra ID
- **No SAS Tokens**: Organization policy prohibits SAS tokens for storage access
- **Managed Identity**: For service-to-service authentication in Azure Container Apps
- **Local Development Authentication**: Use Azure CLI login credentials (Entra ID)
  - `az login` provides DefaultAzureCredential for local testing
  - No need for service principals or API keys locally
  - Seamless transition to Managed Identity in production
- **Storage Access**: Use Managed Identity or Azure CLI credentials (no connection strings or SAS)
- **HTTPS Only**: All communications encrypted
- **Data Residency**: Ensure South Africa region compliance
- **Audit Logging**: Track all interactions for compliance

### API Endpoints (FastAPI)

```
POST   /api/chat              # Send chat message
POST   /api/search            # Perform search
GET    /api/health            # Health check
GET    /api/citations/:id     # Get citation details
WS     /ws/chat               # WebSocket for streaming
```

### Environment Variables (.env)

```bash
# Azure AI Foundry
AZURE_AI_FOUNDRY_PROJECT_ID=
AZURE_AI_FOUNDRY_ENDPOINT=
AZURE_AGENT_ID=

# M365 Agent SDK
AZURE_BOT_ID=
AZURE_BOT_ENDPOINT=

# Azure Container Apps
CONTAINER_APP_NAME=
CONTAINER_APP_RESOURCE_GROUP=

# Azure AI Search (Phase 1B)
AZURE_SEARCH_ENDPOINT=
AZURE_SEARCH_INDEX_NAME=

# Azure Storage (if required - re-use existing)
AZURE_STORAGE_ACCOUNT_NAME=
# Note: No connection strings or SAS tokens - use Managed Identity/Azure CLI

# Entra ID
AZURE_TENANT_ID=
AZURE_CLIENT_ID=
MANAGED_IDENTITY_CLIENT_ID=

# Application Settings
ENVIRONMENT=development
LOG_LEVEL=INFO
PORT=8180  # Default port (configurable to avoid conflicts)
```

## Development Workflow

### 1. Local Development
- **Always use `.venv` virtual environment** for running tests and scripts by preceeding generated command with this command:  .venv\scripts\activate
- use correct syntax for local scripts to be executed  in powershell
- **Maintain `requirements.txt`** as packages are added or removed
- **Cross-platform compatibility**: Code must run on both Windows and Linux
  - Use `pathlib` for file paths (not os.path)
  - Avoid platform-specific system calls
  - Test on both platforms when possible
- Use `./site/` folder HTML pages for UI testing
- Mock API responses for frontend development
- **Docker Compose** for local container testing
  - Build and test Docker images locally before deployment
  - Ensure parity between local Docker and ACA deployment
- **Environment-driven ports** for FastAPI (default: 8080, avoid 8000)
  - Set `PORT` in `.env` to avoid conflicts with other local services
  - FastAPI reads port from environment variable
- **Dev Tunnels** for local FastAPI testing with M365 Agent SDK
  - Use Visual Studio Dev Tunnels or `devtunnel` CLI
  - Expose local FastAPI to public endpoint for M365 Agent SDK callbacks
  - Configure bot messaging endpoint to tunnel URL
  - Enable real-time testing without cloud deployment

### 2. API Development
- FastAPI with async/await patterns
- Pydantic models for request/response validation
- Integration with Azure AI Foundry SDK
- Error handling and retry logic
- Local testing with `uvicorn --reload` and dev tunnels
- **Authentication Strategy**:
  - Local: Use `DefaultAzureCredential` with Azure CLI login (`az login`)
  - Production: Use `DefaultAzureCredential` with Managed Identity (ACA)
  - Single code path for both environments
- **Reference Implementation**: See `experiments/agent-playground.py` for working example of:
  - Azure AI Foundry Projects SDK authentication with `DefaultAzureCredential`
  - Creating and managing agent threads
  - Sending messages and processing agent responses
  - Environment variable configuration with `python-dotenv`

### 3. Frontend Development
- Modern JavaScript (ES6+) or TypeScript
- CSS for responsive design and animations
- Integration with M365 Agent SDK Web Chat
- Testing on saved HTML pages

### 4. Deployment
- **Docker Container for Azure Container Apps**
  - Build multi-stage Dockerfile for FastAPI application
  - Use Python slim or alpine base image for smaller footprint
  - Container must be portable (Linux-based for ACA)
  - Include health check endpoints
- CI/CD pipeline with GitHub Actions
  - Build and push Docker images to Azure Container Registry
  - Deploy container to Azure Container Apps
- Infrastructure as Code (Bicep or Terraform)
- Automated testing before deployment
- Staged rollout (dev → staging → production)

## Implementation Priorities

### Sprint 1: Core Infrastructure
- [ ] Set up M365 Agent SDK resource
- [ ] Create Azure Container Apps environment
- [ ] Set up Azure Container Registry for Docker images
- [ ] Configure Managed Identity for ACA
- [ ] Assign Managed Identity appropriate Azure RBAC roles (AI Foundry, Storage, Search)
- [ ] Verify existing Storage Account or provision if needed (no SAS tokens)
- [ ] Set up Entra ID app registrations
- [ ] Create `.venv` and initial `requirements.txt`
- [ ] Create FastAPI boilerplate with environment-driven port configuration
- [ ] Create Dockerfile (multi-stage, Linux-based for ACA)
- [ ] Create docker-compose.yml for local testing
- [ ] Ensure cross-platform compatibility (Windows/Linux)
- [ ] Implement DefaultAzureCredential for authentication (local + production)
- [ ] Configure dev tunnel for local M365 Agent SDK testing
- [ ] Document local development setup with .venv, Azure CLI login, and tunneling

### Sprint 2: Agent Integration
- [ ] Integrate Azure AI Foundry Projects SDK
- [ ] Connect to existing agent
- [ ] Implement chat endpoint with streaming
- [ ] Test Bing Custom Search grounding

### Sprint 3: Chat UI (Mode 1)
- [ ] Create embeddable chat widget
- [ ] Implement expand/collapse functionality
- [ ] Build message thread UI
- [ ] Add citation rendering
- [ ] Test on local HTML pages

### Sprint 4: Search UI (Mode 2)
- [ ] Create search results list view
- [ ] Implement mode toggle
- [ ] Format clickable URLs and snippets
- [ ] Test search relevance

### Sprint 5: Phase 1B - FAQ Integration
- [ ] Set up Azure AI Search index for FAQs
- [ ] Implement hybrid search
- [ ] Merge results from multiple sources
- [ ] Source attribution logic

### Sprint 6: Polish & Deploy
- [ ] Full-screen mode implementation
- [ ] Accessibility testing
- [ ] Performance optimization
- [ ] Production deployment

## Testing Strategy

### Unit Tests
- FastAPI endpoints
- Agent response processing
- Citation extraction logic

### Integration Tests
- End-to-end chat flow
- Search result formatting
- Multi-source grounding

### UI Tests
- Widget responsiveness
- Mode switching
- Expand/collapse behavior
- Test on saved HTML pages

### Security Tests
- Entra ID authentication
- Managed Identity access
- Input validation
- XSS prevention

## Success Metrics

### Phase 1A
- ✅ Chat widget loads in <2 seconds
- ✅ 95% of queries return relevant responses
- ✅ Full-screen mode works on all devices
- ✅ Both modes (Chat/Search) functional
- ✅ Zero API key usage (Managed Identity only)

### Phase 1B
- ✅ FAQ search results ranked appropriately
- ✅ Multi-source citations displayed correctly
- ✅ Response time <3 seconds for hybrid search

### Phase 2 (Future)
- ✅ User authentication working
- ✅ Contact forms secured
- ✅ User preferences stored

## Key Technical Decisions

1. **Azure AI Foundry Projects SDK**: Modern SDK for agent orchestration
2. **FastAPI**: High-performance async Python framework
3. **Azure Container Apps**: Serverless container hosting with auto-scaling
4. **Docker Containers**: Portable deployment via Docker images to ACA
5. **Cross-Platform Compatibility**: Code must run on both Windows and Linux
6. **Managed Identity**: Eliminates API key management risks (production/ACA only)
7. **Azure CLI Authentication**: For local development using DefaultAzureCredential
8. **M365 Agent SDK**: Future multi-channel support (Teams, SMS, etc.)
9. **Bing Custom Search**: Existing investment, proven results
10. **Azure AI Search**: Structured data with hybrid search capabilities
11. **Azure Storage Account**: Re-use existing if available (no SAS tokens, use Managed Identity)
12. **Dev Tunnels**: Enable local FastAPI testing with M365 Agent SDK without deployment
13. **DefaultAzureCredential Pattern**: Single authentication code path for local and production
14. **Virtual Environment (.venv)**: Isolated Python environment for consistent dependencies
15. **Environment-driven Configuration**: Flexible port assignment to avoid local conflicts

## Documentation Requirements

- [ ] API documentation (OpenAPI/Swagger)
- [ ] Widget integration guide for web developers
- [ ] Security architecture diagram
- [ ] Deployment runbook
- [ ] Monitoring and alerting setup
- [ ] Disaster recovery procedures

## Constraints & Assumptions

### Constraints
- Must use existing Azure AI Foundry agent
- Must use existing Azure AI Search resource
- Re-use existing Azure Storage Account if available
- No API keys allowed
- No SAS tokens allowed (organization policy)
- Public Phase 1 has no user authentication
- Must comply with government accessibility standards
- Always use `.venv` for Python environment isolation
- Maintain `requirements.txt` with all dependencies
- Code must be portable and run on both Windows and Linux
- Azure Container Apps deployment must use Docker containers

### Assumptions
- `.env` file will be populated with correct credentials
- Saved HTML pages in `./site/` are representative of production
- Azure resources are in South Africa region
- Users have modern browsers (last 2 versions)

## Getting Started

1. **Clone Repository**
   ```bash
   git clone <repository-url>
   cd va-chat
   ```

2. **Create and Activate Virtual Environment**
   ```bash
   # Create virtual environment
   python -m venv .venv
   
   # Activate (Windows PowerShell)
   .venv\Scripts\Activate.ps1
   
   # Or activate (Windows CMD)
   .venv\Scripts\activate.bat
   
   # Or activate (Linux/Mac)
   source .venv/bin/activate
   ```

3. **Install Dependencies**
   ```bash
   # Backend (with .venv activated)
   pip install -r requirements.txt
   
   # Frontend
   npm install
   ```

4. **Authenticate with Azure CLI**
   ```bash
   # Login with your Entra ID credentials
   az login
   
   # Verify authentication
   az account show
   
   # Your credentials will be used automatically by DefaultAzureCredential
   # No service principal or API keys needed for local development
   ```

5. **Configure Local Port (Optional)**
   ```bash
   # Edit .env and set PORT to avoid conflicts (default: 8080)
   # Example: PORT=8080 or PORT=5000
   # Avoid port 8000 as it's commonly in use by other services
   ```

6. **Set Up Dev Tunnel (for Bot Framework testing)**
   ```bash
   # Install devtunnel CLI (if not already installed)
   # Windows: winget install Microsoft.devtunnel
   
   # Create a persistent tunnel
   devtunnel create --allow-anonymous
   
   # Start the tunnel on your configured port (e.g., 8080)
   devtunnel port create -p 8080
   devtunnel host
   
   # Note the public URL (e.g., https://abc123.devtunnels.ms)
   # Configure this URL in M365 Agent SDK messaging endpoint
   ```

7. **Run Locally (always with .venv activated)**
   ```bash
   # Ensure .venv is activated
   .venv\Scripts\Activate.ps1
   
   # Option A: Run directly with uvicorn
   uvicorn main:app --reload --host 0.0.0.0 --port $env:PORT
   
   # Option B: Run with Python
   python main.py
   
   # Option C: Run with Docker (test container locally)
   docker-compose up --build
   
   # Start dev tunnel (in another terminal, matching your PORT)
   devtunnel host
   
   # Serve frontend (test with local HTML - different port)
   python -m http.server 9000
   ```

8. **Test Integration**
   - Open `./site/` HTML pages in browser (http://localhost:9000)
   - Inject chat widget script
   - Test both Chat and Search modes
   - Verify M365 Agent SDK callbacks through dev tunnel

## Project Timeline

- **Phase 1A**: 6-8 weeks (Core functionality)
- **Phase 1B**: 2-3 weeks (FAQ integration)
- **Phase 2**: TBD (Authenticated services)

## Support & Contact

- **Primary Developer**: [Your Name]
- **Azure Subscription**: [Subscription ID]
- **Project Repository**: [GitHub URL]
- **Documentation**: [Wiki/Docs URL]

---

**Last Updated**: November 10, 2025  
**Version**: 1.0  
**Status**: Phase 1A - In Development

